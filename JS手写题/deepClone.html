<body>
  
</body>
<script>
  /**
   *  å®žçŽ°æ€è·¯ï¼š
   *  1. åˆ¤æ–­æ•°æ®ç±»åž‹
   *  2. å¯¹è±¡ or æ•°ç»„çš„è¯æˆ‘ä»¬å°±æ–°å»ºä¸€ä¸ªå¯¹è±¡ or æ•°ç»„ï¼Œç„¶åŽéåŽ†ç›®æ ‡å…ƒç´ ï¼Œé€ä¸€æ·»åŠ å…ƒç´ çš„å±žæ€§ï¼Œ
   *     å¦‚æžœå±žæ€§ä»æ˜¯å¼•ç”¨ç±»åž‹ï¼Œåˆ™é€’å½’è¿›è¡Œå¤„ç†ã€‚
   *  3. å¾ªçŽ¯å¼•ç”¨å¤„ç†ï¼šå¦‚æžœå¯¹è±¡å­˜åœ¨å¾ªçŽ¯å¼•ç”¨æƒ…å†µï¼Œåˆ™å¯é€šè¿‡ WeakMap è®°å½•å·²ç»å¤„ç†è¿‡çš„å±žæ€§ï¼ŒåŽç»­é€’å½’è¿‡ç¨‹ä¸­ï¼Œå…ˆæ£€æŸ¥å½“å‰å±žæ€§æ˜¯å¦å­˜åœ¨ WeakMap é‡Œï¼Œ
   *     å¦‚æžœå­˜åœ¨ï¼Œåˆ™ç›´æŽ¥ä»Ž WeakMap é‡Œå–
   *  4. Mapã€Setã€Dateã€Regexp ç­‰æ•°æ®ç±»åž‹ï¼Œå¯ç›´æŽ¥æ–°å»ºä¸€ä¸ªå®žä¾‹
   *  5. å‡½æ•°ç±»åž‹å¯ç›´æŽ¥è¿”å›žï¼Œå®žé™…ä¸Šå¯¹è±¡å¯å…±ç”¨ä¸€ä¸ªå†…å­˜åœ°å€çš„å‡½æ•°ï¼Œlodash ä¹Ÿæ˜¯ç›´æŽ¥è¿”å›žçš„ã€‚
   *  6. è€ƒè™‘æ€§èƒ½ï¼Œå¦‚ä½•éåŽ†å¯¹è±¡ or æ•°ç»„æ•ˆçŽ‡æœ€é«˜ï¼Ÿç­”æ¡ˆæ˜¯ä½¿ç”¨ while è¯­å¥ï¼Œæ€§èƒ½æŽ’è¡Œå¦‚ä¸‹ðŸ‘‡
   *     while > for > for in 
   **/

  function isObject(target) {
    const type = typeof target;
    return type !== null && (type === "object" || type === "function")
  }

  function initType(target) {
    const Cons = target.constructor;
    return new Cons()
  }

  function forEach(array, iterate) {
    let index = -1;
    const length = array.length;
    while(++index < length) {
      iterate(array[index], index)
    }
    return array;
  }

  function deepClone(target, hash = new WeakMap()) {
    if(target instanceof Date) return new Date(target)
    if (target instanceof RegExp) return new RegExp(target)
    if (!isObject(target)) return target;

    const isArray = Array.isArray(target);
    const cloneTarget = initType(target)

    if (hash.has(target)) {
      return hash.get(target)
    }
    hash.set(target, cloneTarget)

    // å¤„ç† Set
    if (target instanceof Set) {
      target.forEach((val) => {
        cloneTarget.add(deepClone(val, hash))
      })
      return cloneTarget;
    }

    // å¤„ç† Map
    if (target instanceof Map) {
      target.forEach((val, key) => {
        cloneTarget.set(key, deepClone(val, hash))
      })
      return cloneTarget
    }

    // å¤„ç†å¯¹è±¡ && æ•°ç»„
    const keys = isArray ? undefined : Object.keys(target);
    forEach(keys || target, (value, key) => {
      if (keys) {
        key = value
      }
      cloneTarget[key] = isObject(target[key]) && typeof target[key] !== "function"
        ? deepClone(target[key], hash)
        : target[key]
    })

    return cloneTarget;
  }

  const obj = {
    a: 1,
    b: undefined,
    c: {
      c1: 'c1'
    },
    d: [1,2,3],
    s: new Set([1,2]),
    m: new Map([[1, 'one']])
  }
  obj.circle = obj;


  const cloneObj1 = deepClone(obj)
  cloneObj1.a = 2;
  cloneObj1.d.push(4)
  cloneObj1.s.add(3)
  cloneObj1.m.set(2, 'two')
  console.log('obj:', obj)
  console.log('cloneObj', cloneObj1)
</script>